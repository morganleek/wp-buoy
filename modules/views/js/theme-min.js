var csv=[],globalCsvs=[],globalCsvsTotal=0,globalCsvCache="",dialog,progressbar,progressLabel,csvKeepGoing=!1,csvHeader="",csvLastDate="";function datawell_memplot_swap(e,a){a.setHours(a.getHours()-8);var s=a.getFullYear()+"-"+(a.getMonth()+1).pad(2)+"-"+a.getDate().pad(2)+" "+a.getHours().pad(2)+":"+a.getMinutes().pad(2),o={action:"fetch_spectrum",buoy_id:e,date:s};$(".memplot").addClass("loading"),$(".panel-memplot .date").text(s),jQuery.post(ajax_object.ajax_url,o,function(e){if("0"!==(e=e.replace("  ",""))){var a=new Image;a.onload=function(){$(".memplot img")[0].src=this.src,$(".memplot").removeClass("loading")},a.src="/wp-admin/admin-ajax.php?action=uwa_datawell_aws&do=image_fetch&key="+e,$('[name="memplot"]').val(e)}else alert("No Frequency-Directional Spectrum for this time"),$(".memplot").addClass("loading")})}function uwa_trigger_tac(e,a,s){dialog=$("#dialog-confirm").dialog({resizable:!1,height:"auto",width:400,modal:!0,buttons:{Accept:function(){"csv"==a?($(this).dialog("close"),e.find('input[name="csv-dates"]').val($('input[name="dates"]').val()),e.submit()):($(this).dialog("close"),uwa_trigger_spec_progress(e,s))},Cancel:function(){$(this).dialog("close"),uwa_reset_csv_downloads()}},close:function(e,a){uwa_reset_csv_downloads()}})}function uwa_trigger_spec_progress(e,a){$("#dialog-csv-progress").dialog({resizable:!1,height:"auto",width:400,modal:!0,buttons:{Cancel:function(){$(this).dialog("close"),uwa_reset_csv_downloads()}},close:function(e,a){uwa_reset_csv_downloads()}}),progressbar=$("#progressbar"),progressLabel=$(".progress-label"),progressbar.progressbar({value:0,change:function(){progressLabel.text(progressbar.progressbar("value")+"%")},complete:function(){progressLabel.text("Complete!")}}),uwa_datawell_spectrum_fetch($('[name="dates"]').val(),$('[name="csv-buoy_id"]').val(),a)}function uwa_file_download(e,a){var s=new Blob([a],{type:"text/csv"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(s,e);else{var o=window.document.createElement("a");o.href=window.URL.createObjectURL(s),o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o)}}function uwa_iterate_csvs_and_concat(){if(0===globalCsvs&&(window.alert("No specturm data currently available for this time period"),progressLabel.text("No Data"),uwa_reset_csv_downloads()),csvKeepGoing)if(globalCsvs.length>0){var e=globalCsvs.pop(),a=globalCsvsTotal-globalCsvs.length;progressbar.progressbar("value",Math.floor(a/globalCsvsTotal*100));var s={action:"uwa_datawell_aws",do:"csv_download",key:e};console.log(e),jQuery.get(ajax_object.ajax_url,s,function(e){var a=e.split("\n"),s=a.splice(0,10).join("\n");csvLastDate=s.split("\n").splice(2,1).join(),0===csvHeader.length&&(csvHeader=s),globalCsvCache+=s.split("\n").splice(2,1).join()+"\n"+a.join("\n"),uwa_iterate_csvs_and_concat()})}else progressLabel.text("Complete!"),csvLastDate=csvLastDate.replace("Data_time:",""),uwa_file_download("spectrum.csv",(csvHeader=csvHeader.replace("UTC","UTC - "+csvLastDate))+"\n"+globalCsvCache),uwa_reset_csv_downloads();else uwa_reset_csv_downloads()}function uwa_reset_csv_downloads(){csvKeepGoing=!1,csvHeader="",csvLastDate="",globalCsvCache="",globalCsvsTotal=0}function uwa_datawell_spectrum_fetch(e,a,s){var o={action:"uwa_datawell_aws",do:"spectrum_csvs",dates:encodeURIComponent(e),buoy_id:a,spectrum:s};jQuery.getJSON(ajax_object.ajax_url,o,function(e){"0"!==e?(globalCsvs=e,globalCsvsTotal=e.length,console.log("Found "+e.length+" items"),csvKeepGoing=!0,uwa_iterate_csvs_and_concat()):(alert("No Frequency-Directional Spectrum for this time"),$(".memplot").addClass("loading"))})}Number.prototype.pad=function(e){for(var a=String(this);a.length<(e||2);)a="0"+a;return a},$.when($.ready).then(function(){$(".csv-form button").not("[disabled]").on("click",function(e){e.preventDefault();var a="",s="",o;$(this).parent().hasClass("csv-form-2d")||$(this).parent().hasClass("csv-form-1d")?(a="specrum",s=$(this).parent().hasClass("csv-form-2d")?"2d":"1d"):a="csv",uwa_trigger_tac($(this).parent(),a,s)}),$(".csv-form button[disabled]").on("click",function(e){e.preventDefault()}),$(".ui-dialog-titlebar-close").on("click",function(){console.log("a"),uwa_reset_csv_downloads()})}),$(window).on("load",function(){});